<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-578SDWQPSK"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-578SDWQPSK');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports App</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f9f9f9; /* Light background */
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            color: #354050;
        }
    
        header {
            background-color: #007bff; /* Primary color */
            padding: 10px 20px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }
    
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }
    
        h1 {
            margin: 20px 0;
        }
    
        label {
            font-weight: bold;
        }
    
        select, input[type="date"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 178px; /* Adjust for padding and border */
            display: block;
        }
        .sportSelect {
            width: 200px;
        }
    
        #gamesList {
            list-style-type: none;
            padding: 0;
        }
    
        .game-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            background-color: #fff; /* Card background */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .games-card {
            text-align: center;
        }


        button:disabled {
            background-color: #cccccc; /* Light grey background */
            color: #666666; /* Dark grey text */
            cursor: not-allowed; /* Change cursor to not-allowed */
            opacity: 0.6; /* Reduce opacity */
        }
    
        button, a {
            background-color: #007bff; /* Primary color */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px; /* Increased padding */
            min-width: 120px; /* Set a minimum width */
            text-align: center; /* Center text */
            text-decoration: none;
            transition: background-color 0.3s;
            display: inline-block; /* Ensure it's treated as an inline-block element */
        }

        button:hover, a:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }

        .circle{
        position: absolute;
        border-radius: 50%;
        background: white;
        animation: ripple 15s infinite;
        box-shadow: 0px 0px 1px 0px #508fb9;
        }

        .small {
            width: 50px;
            height: 50px;
            left: -25px;
            bottom: -25px;
        }

        .medium {
            width: 100px;
            height: 100px;
            left: -50px;
            bottom: -50px;
        }

        .large {
            width: 150px;
            height: 150px;
            left: -75px;
            bottom: -75px;
        }

        .xlarge {
            width: 200px;
            height: 200px;
            left: -100px;
            bottom: -100px;
        }

        .xxlarge {
            width: 250px;
            height: 250px;
            left: -125px;
            bottom: -125px;
        }

        @media (min-width: 768px) {
            .small {
                width: 150px;
                height: 150px;
                left: -75px;
                bottom: -75px;
            }

            .medium {
                width: 300px;
                height: 300px;
                left: -150px;
                bottom: -150px;
            }

            .large {
                width: 450px;
                height: 450px;
                left: -225px;
                bottom: -225px;
            }

            .xlarge {
                width: 600px;
                height: 600px;
                left: -300px;
                bottom: -300px;
            }

            .xxlarge {
                width: 750px;
                height: 750px;
                left: -375px;
                bottom: -375px;
            }
        }

        .shade1{
        opacity: 0.2;
        }
        .shade2{
        opacity: 0.5;
        }

        .shade3{
        opacity: 0.7;
        }

        .shade4{
        opacity: 0.8;
        }

        .shade5{
        opacity: 0.9;
        }

        @keyframes ripple{
        0%{
            transform: scale(0.8);
        }
        
        50%{
            transform: scale(1.2);
        }
        
        100%{
            transform: scale(0.8);
        }
        }

    
        /* Responsive Styles */
        @media only screen and (max-width: 600px) {
            body {
                font-size: 14px;
            }
        }
        @media only screen and (min-width: 601px) and (max-width: 768px) {
            body {
                font-size: 16px;
            }
        }
        @media only screen and (min-width: 769px) {
            body {
                font-size: 18px;
            }
        }

        table {
            width: 80%;
            border-collapse: collapse;
            margin-left: auto;
            margin-right: auto;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #d8ebff;
        }
        tr:nth-child(odd) {
            background-color: #FFFFFF;
        }
        .odds-category {
            margin-top: 10px;
        }
        .odds-category h4 {
            margin-bottom: 5px;
            color: #007bff;
        }
        .odds-category ul {
            list-style-type: none;
            padding: 0;
        }
        .center {
            text-align: center;
        }

        /* Button Group CSS */
        .button-group {
            display: inline-flex;
            margin: 10px 0;
        }

        .button-group button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #f0f0f0;
            color: #333;
        }

        .button-group button.active {
            background-color: #007bff;
            color: #fff;
        }

        .split-button-left {
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
            border-right: none;
            border-top-right-radius: 0px;
            border-bottom-right-radius: 0px;
        }

        .split-button-right {
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            border-top-left-radius: 0px;
            border-bottom-left-radius: 0px;
        }

        /* Loading Overlay CSS */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none; /* Initially hidden */
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 10px;
            color: #fff;
            font-size: 18px;
            text-align: center;
        }
    </style>
    <script type="module">
        import { filterSports } from './static/js/filterSports.js';

        document.addEventListener('DOMContentLoaded', () => {
            const excludedSports = {{ excluded_sports | tojson }};

            const datePicker = document.getElementById('datepicker');
            const gamesList = document.getElementById('gamesList');
            const sportSelect = document.getElementById('sportSelect');
            const allGamesButtonGroup = document.getElementById('allGamesButtonGroup');
            const trendsButton = document.getElementById('trendsButton');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const buttonGroup = document.querySelector('.button-group');

            const fetchAndDisplaySports = () => {
                setLoadingState(true);
                fetch('/api/sports')
                    .then(response => response.json())
                    .then(data => {
                        const filteredData = filterSports(data);
                        sportSelect.innerHTML = filteredData.map(sport => `
                            <option value="${sport.key}" ${sport.key === 'americanfootball_nfl' ? 'selected' : ''}>${sport.title}</option>
                        `).join('');
                        updateButtonDisplay(sportSelect.value);
                        fetchAndDisplayGames(sportSelect.value, datePicker.value);
                        setLoadingState(false);
                    })
                    .catch(error => {
                        console.error('Error fetching sports:', error);
                        setLoadingState(false);
                    });
            };

            const fetchAndDisplayGames = (sportKey, date) => {
                setLoadingState(true);
                fetch(`/sports/${sportKey}?date=${date}`)
                    .then(response => response.text())
                    .then(html => {
                        gamesList.innerHTML = html;
                        setLoadingState(false);

                        // Check if there are any games returned
                        const noGames = gamesList.querySelectorAll('tr').length === 0;
                        console.log(noGames);
                        if (noGames) {
                            allGamesButtonGroup.disabled = true;
                            trendsButton.disabled = true;
                        } else {
                            allGamesButtonGroup.disabled = false;
                            trendsButton.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching games:', error);
                        setLoadingState(false);
                    });
            };

            const fetchAndDisplayTrends = () => {
                setLoadingState(true);
                const sportKey = sportSelect.value;
                const date = datePicker.value;
                fetch(`/trends?sport_key=${sportKey}&date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.task_id) {
                            checkTaskStatus(data.task_id);
                        } else {
                            console.error('Error fetching trends:', data);
                            setLoadingState(false);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching trends:', error);
                        setLoadingState(false);
                    });
            };

            const checkTaskStatus = (taskId) => {
                fetch(`/status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.state === 'PENDING') {
                            setTimeout(() => checkTaskStatus(taskId), 1000);
                        } else if (data.state === 'SUCCESS') {
                            displayTrends(data.result);
                            setLoadingState(false);
                        } else {
                            console.error('Error fetching task status:', data);
                            setLoadingState(false);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching task status:', error);
                        setLoadingState(false);
                    });
            };

            const displayTrends = (data) => {
                const { result, sport_key, current_date } = data;
                const gamesList = document.getElementById('gamesList'); // Assuming you have an element with id 'gamesList'
                gamesList.innerHTML = ''; // Clear previous results

                const title = document.createElement('h1');
                title.className = 'center';
                title.textContent = 'Game Information';
                gamesList.appendChild(title);

                if (Array.isArray(result) && result.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Home Team</th>
                                <th>Away Team</th>
                                <th>Home Score</th>
                                <th>Away Score</th>
                                <th>Odds</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.map(match => `
                                <tr>
                                    <td>${match.homeTeam}</td>
                                    <td>${match.awayTeam}</td>
                                    <td>${match.homeScore}</td>
                                    <td>${match.awayScore}</td>
                                    <td>
                                        <div class="odds-category">
                                            <h4>H2H:</h4>
                                            <ul>
                                                ${match.odds.h2h.map(odd => `<li>${odd}</li>`).join('')}
                                            </ul>
                                            <h4>Spreads:</h4>
                                            <ul>
                                                ${match.odds.spreads.map(odd => `<li>${odd}</li>`).join('')}
                                            </ul>
                                            <h4>Totals:</h4>
                                            <ul>
                                                ${match.odds.totals.map(odd => `<li>${odd}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </td>
                                    <td><a href="/game/${match.game_id}?sport_key=${sport_key}&date=${current_date}" class="view-details">View Details</a></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    gamesList.appendChild(table);
                } else {
                    const noGamesMessage = document.createElement('p');
                    noGamesMessage.className = 'center';
                    noGamesMessage.textContent = 'No games on this date';
                    gamesList.appendChild(noGamesMessage);
                }
            };

            const setLoadingState = (isLoading) => {
                if (isLoading) {
                    loadingOverlay.classList.add('active');
                } else {
                    loadingOverlay.classList.remove('active');
                }
            };

            const handleButtonClick = (button) => {
                // Fetch and display the appropriate data
                if (button === allGamesButtonGroup) {
                    trendsButton.classList.remove('active');
                    allGamesButtonGroup.classList.add('active');
                    fetchAndDisplayGames(sportSelect.value, datePicker.value);
                } else if (button === trendsButton) {
                    allGamesButtonGroup.classList.remove('active');
                    trendsButton.classList.add('active');
                    fetchAndDisplayTrends();
                }
            };

            const updateButtonDisplay = (sportKey) => {
                if (excludedSports.includes(sportKey)) {
                    buttonGroup.style.display = 'none';
                } else {
                    buttonGroup.style.display = 'flex';
                }
            };

            // Set default date to today
            const currentDate = new Date().toISOString().split('T')[0];
            datePicker.value = currentDate;

            // Fetch and display sports and games for the current date on load
            fetchAndDisplaySports();

            sportSelect.addEventListener('change', (event) => {
                // Update button display based on selected sport
                updateButtonDisplay(event.target.value);
                // Set the initial active button
                handleButtonClick(allGamesButtonGroup);
                fetchAndDisplayGames(event.target.value, datePicker.value);
            });

            datePicker.addEventListener('change', (event) => {
                // Set the active button based on the current active button
                if (allGamesButtonGroup.classList.contains('active')) {
                    handleButtonClick(allGamesButtonGroup);
                    fetchAndDisplayGames(sportSelect.value, event.target.value);
                } else if (trendsButton.classList.contains('active')) {
                    handleButtonClick(trendsButton);
                    fetchAndDisplayTrends();
                }
            });

            // Add event listeners for the buttons
            allGamesButtonGroup.addEventListener('click', () => handleButtonClick(allGamesButtonGroup));
            trendsButton.addEventListener('click', () => handleButtonClick(trendsButton));

            // Add event listener for "View Details" links
            document.addEventListener('click', (event) => {
                if (event.target.matches('.view-details')) {
                    setLoadingState(true);
                }
            });

            // Add pageshow event listener to hide the loading spinner when navigating back
            window.addEventListener('pageshow', (event) => {
                if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                    setLoadingState(false);
                }
            });
        });
    </script>
    <script>
        function goToNextGame(nextGameDate) {
            const datePicker = document.getElementById('datepicker');
            
            // Reformat nextGameDate from MM-DD-YYYY to YYYY-MM-DD
            const [month, day, year] = nextGameDate.split('-');
            const formattedDate = `${year}-${month}-${day}`;
            
            datePicker.value = nextGameDate;
            
            // Manually dispatch the change event
            const event = new Event('change');
            datePicker.dispatchEvent(event);
        }
    </script>
</head>
<body>
    <header>
        <div class='ripple-background'>
            <div class='circle xxlarge shade1'></div>
            <div class='circle xlarge shade2'></div>
            <div class='circle large shade3'></div>
            <div class='circle mediun shade4'></div>
            <div class='circle small shade5'></div>
          
            <nav>
                <a href="/">Home</a>
                <a href="/betting-guide">Betting Guide</a> <!-- New link -->
            </nav>
            <h1>Get STAM</h1>
            <h2>Stats That Actually Matter</h2>
            </div>
    </header>
    <label for="sportSelect">Select Sport:</label>
    <select id="sportSelect" class="sportSelect"></select>
    <br>
    <label for="datepicker">Select Date:</label>
    <input type="date" id="datepicker">
    <div class="button-group" style="display: none;">
        <button id="allGamesButtonGroup" class="split-button-left active">View All Games</button>
        <button id="trendsButton" class="split-button-right">View Games with Trends</button>
    </div>
    <ul id="gamesList"></ul>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>
</body>
</html>
